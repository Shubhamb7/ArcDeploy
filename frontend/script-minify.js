document.addEventListener("DOMContentLoaded",()=>{let e=document.querySelectorAll(".toolbox-item"),t=document.getElementById("drawingArea"),a=null,n=0,l=0,s=!1,i=0,d=0,p=0,r=0,c=null;e.forEach(e=>{e.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",e.target.textContent)})}),t.addEventListener("dragover",e=>{e.preventDefault()}),t.addEventListener("drop",e=>{e.preventDefault();let o=e.dataTransfer.getData("text/plain"),u=document.createElement("div");u.className="diagram",u.contentEditable=!0,"AWS Cloud"===o?u.classList.add("awscloud"):"Region"===o?u.classList.add("region"):"VPC"===o?u.classList.add("vpc"):"Subnet"===o?u.classList.add("subnet"):"Private Subnet"===o?u.classList.add("privatesubnet"):"Region"===o?u.classList.add("region"):"EC2"===o&&u.classList.add("ec2"),u.textContent=o,u.addEventListener("mousedown",e=>{s||(a=u,n=e.clientX-a.offsetLeft,l=e.clientY-a.offsetTop)}),u.addEventListener("mousemove",e=>{if(!s&&a===u){let t=e.clientX-n,i=e.clientY-l;a.style.left=t+"px",a.style.top=i+"px"}}),u.addEventListener("mouseup",()=>{a=null}),u.addEventListener("mouseleave",()=>{a=null}),u.addEventListener("mousedown",e=>{i=e.clientX,d=e.clientY,p=u.offsetWidth,r=u.offsetHeight,e.target.classList.contains("resize-handle")&&a===u&&(s=!0)}),u.addEventListener("mousemove",e=>{if(s&&a===u){let t=p+(e.clientX-i),n=r+(e.clientY-d);u.style.width=t+"px",u.style.height=n+"px"}}),u.addEventListener("mouseup",()=>{s=!1}),u.addEventListener("contextmenu",e=>{if(2===e.button&&u.classList.contains("awscloud")){e.preventDefault(),m();let t=e.target,a=t.dataset.project||"test";(c=document.createElement("div")).className="context-menu",c.style.left=e.clientX+"px",c.style.top=e.clientY+"px";let n=document.createElement("label");n.textContent="Project Name:";let l=document.createElement("input");l.type="text",l.className="input-aws-project",l.value=a;let s=document.createElement("button");s.textContent="OK",s.addEventListener("click",()=>{t.dataset.project=l.value,m()}),c.appendChild(n),c.appendChild(l),c.appendChild(s),document.body.appendChild(c)}}),u.addEventListener("contextmenu",e=>{if(2===e.button&&u.classList.contains("region")){e.preventDefault(),m();let t=e.target,a=t.dataset.awsRegion||"us-east-1";(c=document.createElement("div")).className="context-menu",c.style.left=e.clientX+"px",c.style.top=e.clientY+"px";let n=document.createElement("label");n.textContent="AWS Region:";let l=document.createElement("input");l.type="text",l.className="input-aws-region",l.value=a;let s=document.createElement("button");s.textContent="OK",s.addEventListener("click",()=>{t.dataset.awsRegion=l.value,m()}),c.appendChild(n),c.appendChild(l),c.appendChild(s),document.body.appendChild(c)}}),u.addEventListener("contextmenu",e=>{if(2===e.button&&u.classList.contains("vpc")){e.preventDefault(),m();let t=e.target;(c=document.createElement("div")).className="context-menu",c.style.left=e.clientX+"px",c.style.top=e.clientY+"px";let a=document.createElement("label");a.textContent="CIDR:";let n=document.createElement("input");n.type="text",n.className="input-cidr",n.value=t.dataset.cidr||"10.10.0.0/16";let l=document.createElement("button");l.textContent="OK",l.addEventListener("click",()=>{t.dataset.cidr=n.value,m()}),c.appendChild(a),c.appendChild(n),c.appendChild(l),document.body.appendChild(c)}}),u.addEventListener("contextmenu",e=>{if(2===e.button&&u.classList.contains("subnet")||2===e.button&&u.classList.contains("privatesubnet")){e.preventDefault(),m();let t=e.target,a=t.dataset.availabilityZone||"us-east-1a",n=t.dataset.subnetCidr||"10.10.1.0/24";(c=document.createElement("div")).className="context-menu",c.style.left=e.clientX+"px",c.style.top=e.clientY+"px";let l=document.createElement("label");l.textContent="Availability Zone:";let s=document.createElement("input");s.type="text",s.className="input-availability-zone",s.value=a;let i=document.createElement("label");i.textContent="Subnet CIDR:";let d=document.createElement("input");d.type="text",d.className="input-subnet-cidr",d.value=n;let p=document.createElement("button");p.textContent="OK",p.addEventListener("click",()=>{t.dataset.availabilityZone=s.value,t.dataset.subnetCidr=d.value,m()}),c.appendChild(l),c.appendChild(s),c.appendChild(i),c.appendChild(d),c.appendChild(p),document.body.appendChild(c)}}),u.addEventListener("contextmenu",e=>{if(2===e.button&&u.classList.contains("ec2")){e.preventDefault(),m();let t=e.target,a={keyPair:t.dataset.keyPair||"keypair",instanceType:t.dataset.instanceType||"t2.small",operatingSystem:t.dataset.operatingSystem||"ubuntu",ephemeralStorage:t.dataset.ephemeralStorage||"30"};(c=document.createElement("div")).className="context-menu",c.style.left=e.clientX+"px",c.style.top=e.clientY+"px";let n=document.createElement("label");n.textContent="Key Pair Name:";let l=document.createElement("input");l.type="text",l.className="input-key-type",l.value=a.keyPair;let s=document.createElement("label");s.textContent="Instance Type:";let i=document.createElement("input");i.type="text",i.className="input-instance-type",i.value=a.instanceType;let d=document.createElement("label");d.textContent="Operating System:";let p=document.createElement("input");p.type="text",p.className="input-operating-system",p.value=a.operatingSystem;let r=document.createElement("label");r.textContent="Ephemeral Storage:";let o=document.createElement("input");o.type="text",o.className="input-ephemeral-storage",o.value=a.ephemeralStorage;let v=document.createElement("button");v.textContent="OK",v.addEventListener("click",()=>{t.dataset.instanceType=i.value,t.dataset.operatingSystem=p.value,t.dataset.keyPair=l.value,t.dataset.ephemeralStorage=o.value,m()}),c.appendChild(s),c.appendChild(i),c.appendChild(d),c.appendChild(p),c.appendChild(n),c.appendChild(l),c.appendChild(r),c.appendChild(o),c.appendChild(v),document.body.appendChild(c)}}),t.appendChild(u)});let o=document.getElementById("trackButton");function u(e){let t=Array.from(e.childNodes).filter(e=>e.nodeType===Node.ELEMENT_NODE),a="",n=[],l=[],s=[],i=[];return t.forEach(e=>{let d=e.textContent.trim(),p=e.classList.contains("ec2")?"EC2":e.classList.contains("subnet")?"Subnet":e.classList.contains("privatesubnet")?"PrivateSubnet":e.classList.contains("vpc")?"VPC":e.classList.contains("region")?"Region":"Project",{left:r,top:c,width:o,height:u}=e.getBoundingClientRect();if("Project"===p&&(a=e.dataset.project||""),"EC2"===p){let m=e.dataset.keyPair||"",v=e.dataset.instanceType||"",y=e.dataset.operatingSystem||"",C=e.dataset.ephemeralStorage||"";i.push({name:d,type:p,instanceType:v,operatingSystem:y,keyPair:m,ephemeralStorage:C})}if("Subnet"===p||"PrivateSubnet"===p){let h=e.dataset.availabilityZone||"",E=e.dataset.subnetCidr||"",b={name:d,type:p,availabilityZone:h,subnetCidr:E,instances:[]},f=t.filter(e=>e.classList.contains("ec2")).filter(e=>{let{left:t,top:a}=e.getBoundingClientRect();return t>=r&&t+e.offsetWidth<=r+o&&a>=c&&a+e.offsetHeight<=c+u}).map(e=>({name:e.textContent.trim(),type:"EC2",instanceType:e.dataset.instanceType||"",operatingSystem:e.dataset.operatingSystem||"",keyPair:e.dataset.keyPair||"",ephemeralStorage:e.dataset.ephemeralStorage||""}));b.instances.push(...f),s.push(b)}if("VPC"===p){let g=e.dataset.cidr||"",x={name:d,type:p,cidr:g,subnets:[]},L=t.filter(e=>e.classList.contains("subnet")||e.classList.contains("privatesubnet")).filter(e=>{let{left:t,top:a}=e.getBoundingClientRect();return t>=r&&t+e.offsetWidth<=r+o&&a>=c&&a+e.offsetHeight<=c+u}).map(e=>({name:e.textContent.trim(),type:e.classList.contains("privatesubnet")?"PrivateSubnet":"Subnet",availabilityZone:e.dataset.availabilityZone||"",subnetCidr:e.dataset.subnetCidr||"",instances:[]}));x.subnets.push(...L),l.push(x)}if("Region"===p){let S=e.dataset.awsRegion||"",N={name:d,type:p,region:S,vpcs:[]},P=t.filter(e=>e.classList.contains("vpc")).filter(e=>{let{left:t,top:a}=e.getBoundingClientRect();return t>=r&&t+e.offsetWidth<=r+o&&a>=c&&a+e.offsetHeight<=c+u}).map(e=>({name:e.textContent.trim(),type:"VPC",cidr:e.dataset.cidr||"",subnets:[]}));N.vpcs.push(...P),n.push(N)}}),{projectName:a,regions:n,vpcs:l,subnets:s,instances:i}}function m(){c&&(c.remove(),c=null)}o.addEventListener("click",()=>{let e=u(t),a=JSON.stringify(e,null,2);console.log(a);fetch("http://localhost:8080/arc",{method:"POST",headers:{"Content-Type":"application/json"},body:a}).then(e=>e.json()).then(e=>{console.log("Response:",e)}).catch(e=>{console.error("Error:",e)})})});